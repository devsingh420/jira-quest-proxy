<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>âš”ï¸ Jira Quest</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#1a1c2c;color:#f4f4f4;font-family:monospace;min-height:100vh;padding:10px 12px;overflow-x:hidden;}
button{cursor:pointer;font-family:monospace;}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding:8px 14px;background:#16213e;border-radius:8px;border:2px solid #f0c040;box-shadow:0 0 20px #f0c04033;}
.tabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;}
.tab{background:#16213e;color:#566c86;border:1px solid #4a4e8c;border-radius:6px;padding:5px 10px;font-size:11px;font-weight:bold;}
.tab.active{background:#f0c040;color:#1a1c2c;border-color:#f0c040;}
.panel{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:14px;}
.bar-wrap{background:#111;border-radius:3px;height:6px;overflow:hidden;flex:1;}
.bar-fill{height:100%;border-radius:3px;transition:width 0.6s;}
.card{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:10px 12px;cursor:pointer;transition:all 0.2s;}
.card:hover{border-color:#f0c040;transform:translateY(-2px);}
.roster{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:8px;}
.badge{color:#fff;padding:1px 6px;border-radius:8px;font-size:9px;text-align:center;white-space:nowrap;}
::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-track{background:#111;} ::-webkit-scrollbar-thumb{background:#4a4e8c;border-radius:2px;}

/* Board columns */
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;align-items:start;}
.col{background:#0f0f1b;border-radius:8px;padding:10px;min-height:200px;border:2px solid transparent;transition:border-color 0.2s;}
.col.drag-over{border-color:#f0c040;background:#1a1800;}
.col-title{font-size:11px;font-weight:bold;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #2a2a3a;}
.ticket{background:#16213e;border-radius:6px;padding:8px;margin-bottom:6px;cursor:grab;border-left:3px solid #566c86;font-size:10px;transition:all 0.2s;user-select:none;}
.ticket:hover{transform:translateY(-1px);box-shadow:0 4px 12px #00000066;}
.ticket.dragging{opacity:0.4;cursor:grabbing;}
.ticket-key{color:#566c86;font-size:9px;}
.ticket-title{color:#f4f4f4;margin:2px 0;line-height:1.4;}
.ticket-meta{display:flex;align-items:center;gap:4px;margin-top:4px;}
.ticket-pts{background:#2a2a3a;color:#f0c040;padding:1px 5px;border-radius:4px;font-size:9px;}
.ticket-assignee{font-size:12px;}
.done-btn{background:none;border:1px solid #38b764;color:#38b764;border-radius:4px;padding:1px 6px;font-size:9px;margin-left:auto;}
.done-btn:hover{background:#38b764;color:#fff;}

/* Hero Modal */
.modal-bg{position:fixed;inset:0;background:#000000cc;z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal{background:#16213e;border:2px solid #4a4e8c;border-radius:12px;padding:20px;width:500px;max-width:95vw;max-height:85vh;overflow-y:auto;position:relative;}
.modal-close{position:absolute;top:10px;right:12px;background:none;border:none;color:#566c86;font-size:18px;cursor:pointer;}
.quest-item{display:flex;align-items:center;gap:8px;background:#0f0f1b;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid #566c86;}
.status-select{background:#0f0f1b;color:#f4f4f4;border:1px solid #4a4e8c;border-radius:4px;padding:2px 4px;font-size:9px;font-family:monospace;cursor:pointer;}

/* Confetti */
.confetti-piece{position:fixed;width:8px;height:8px;top:-10px;z-index:999;pointer-events:none;border-radius:2px;animation:confettiFall linear forwards;}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}

/* Level up overlay */
.levelup{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.levelup-box{background:#1a1c2c;border:3px solid #f0c040;border-radius:16px;padding:30px 50px;text-align:center;animation:levelupPop 0.4s ease-out,levelupFade 0.5s 2s forwards;box-shadow:0 0 60px #f0c04088;}
@keyframes levelupPop{0%{transform:scale(0.3);opacity:0;}70%{transform:scale(1.1);}100%{transform:scale(1);opacity:1;}}
@keyframes levelupFade{to{opacity:0;transform:scale(1.2);}}

/* Shake */
@keyframes shake{0%,100%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-6px);}80%{transform:translateX(6px);}}
.shake{animation:shake 0.5s ease-out;}

/* Sprint timer */
.timer-ring{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;border:3px solid #f0c040;color:#f0c040;flex-direction:column;flex-shrink:0;}

/* Map */
.map-wrap{display:grid;grid-template-columns:1fr 240px;gap:10px;}
.inspector{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:12px;}
canvas{border-radius:8px;border:2px solid #4a4e8c;width:100%;height:auto;cursor:pointer;}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:#16213e;border:1px solid #38b764;border-radius:8px;padding:10px 16px;font-size:11px;z-index:300;animation:toastIn 0.3s ease-out,toastOut 0.3s 2.5s forwards;}
@keyframes toastIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes toastOut{to{transform:translateY(20px);opacity:0;}}

.loading{min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;}
.log-line{color:#29adff;font-size:10px;margin-bottom:2px;}
</style>
</head>
<body>
<div id="app"><div class="loading"><div style="font-size:48px">âš”ï¸</div><div style="color:#f0c040;font-size:18px;letter-spacing:3px">JIRA QUEST</div><div style="color:#566c86;font-size:12px">Loading your sprint...</div><div id="logBox" style="background:#0f0f1b;padding:12px;border-radius:8px;max-height:180px;overflow-y:auto;min-width:300px;margin-top:8px;"></div></div></div>
<div id="overlays"></div>

<script>
const BOARD_ID = 124;
const PROXY = '/.netlify/functions/jira';
const JIRA_STATUSES = ['To Do','In Progress','In Review','Done'];
const STATUS_COLORS = {'To Do':'#566c86','In Progress':'#f0a030','In Review':'#9b59b6','Code Review':'#9b59b6','Done':'#38b764','Blocked':'#e43b44','Selected for Development':'#3b7fd4'};
const ROLES=['Warrior','Mage','Ranger','Healer','Rogue','Paladin','Bard','Druid'];
const AVATARS=['âš”ï¸','ğŸ§™','ğŸ¹','âœ¨','ğŸ—¡ï¸','ğŸ›¡ï¸','ğŸµ','ğŸŒ¿','ğŸ”¥','ğŸ’','ğŸŒ™','âš¡'];
const MCOLORS=['#9b59b6','#e43b44','#38b764','#29adff','#f0c040','#f0a030','#e91e8c','#00bcd4'];
const ZONES=[
  {name:'Feature Forest',color:'#1a4a2a',border:'#38b764',icon:'ğŸŒ²',match:['in progress']},
  {name:'Review Citadel',color:'#2a1a3a',border:'#9b59b6',icon:'ğŸ°',match:['review']},
  {name:'Bug Dungeon',color:'#2a1a1a',border:'#e43b44',icon:'ğŸ•·ï¸',match:['blocked']},
  {name:'Victory Plains',color:'#2a2a1a',border:'#f0c040',icon:'ğŸ†',match:['done']},
  {name:'Idle Town',color:'#1a1a2a',border:'#566c86',icon:'ğŸ˜ï¸',match:['to do','backlog','open','selected']},
];
const ZL=[{x:5,y:5,w:42,h:42},{x:54,y:5,w:42,h:42},{x:5,y:54,w:28,h:42},{x:36,y:54,w:28,h:42},{x:67,y:54,w:28,h:42}];

let S={team:[],issues:[],sprintName:'',sprintEnd:null,tab:'board',selected:null,lastSync:null,dragIssue:null,mapTick:0};
let mcache={}, animFrame=null, toastTimeout=null;

const sColor=s=>STATUS_COLORS[s]||'#566c86';
const getZone=s=>ZONES.find(z=>z.match.some(m=>(s||'').toLowerCase().includes(m)))?.name||'Idle Town';
const getMI=id=>{
  if(mcache[id])return mcache[id];
  const i=Object.keys(mcache).length;
  mcache[id]={role:ROLES[i%ROLES.length],avatar:AVATARS[i%AVATARS.length],color:MCOLORS[i%MCOLORS.length],hp:60+((i*17)%40),mp:40+((i*23)%60)};
  return mcache[id];
};

function log(msg){const b=document.getElementById('logBox');if(!b)return;const d=document.createElement('div');d.className='log-line';d.textContent=msg;b.appendChild(d);b.scrollTop=b.scrollHeight;}

// â”€â”€ JIRA API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function jiraFetch(path,method='GET',body=null){
  const url=`${PROXY}?path=${encodeURIComponent(path)}`;
  const opts={method:'GET',headers:{'Content-Type':'application/json'}};
  if(method!=='GET'){
    // For mutations, pass method and body as query params handled by proxy
    const mUrl=`${PROXY}?path=${encodeURIComponent(path)}&method=${method}`;
    const res=await fetch(mUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok)throw new Error(`${res.status}`);
    return res.status===204?{}:res.json();
  }
  const res=await fetch(url,opts);
  if(!res.ok)throw new Error(`Proxy ${res.status}`);
  return res.json();
}

async function updateIssueStatus(issueKey, statusName){
  // Get available transitions
  const tData=await jiraFetch(`/rest/api/3/issue/${issueKey}/transitions`);
  const transition=tData.transitions?.find(t=>t.name===statusName||t.to?.name===statusName);
  if(!transition)throw new Error(`No transition to "${statusName}" for ${issueKey}`);
  await jiraFetch(`/rest/api/3/issue/${issueKey}/transitions`,  'POST', {transition:{id:transition.id}});
}

async function fetchData(){
  try{
    log('ğŸ”„ Fetching sprint...');
    const sd=await jiraFetch(`/rest/agile/1.0/board/${BOARD_ID}/sprint?state=active`);
    const sprint=sd.values?.[0];
    if(!sprint)throw new Error('No active sprint');
    S.sprintName=sprint.name;
    S.sprintEnd=sprint.endDate?new Date(sprint.endDate):null;
    log(`âœ… ${sprint.name}`);

    log('ğŸ”„ Fetching issues...');
    const id=await jiraFetch(`/rest/agile/1.0/board/${BOARD_ID}/sprint/${sprint.id}/issue?maxResults=100&fields=summary,assignee,status,customfield_10016,priority`);
    const raw=id.issues||[];
    log(`âœ… ${raw.length} issues`);

    S.issues=raw.map(i=>({
      key:i.key,summary:i.fields?.summary||'',
      status:i.fields?.status?.name||'To Do',
      assigneeId:i.fields?.assignee?.accountId||null,
      assigneeName:i.fields?.assignee?.displayName||'Unassigned',
      points:i.fields?.customfield_10016||0,
    }));

    const am={};
    raw.forEach(i=>{
      const a=i.fields?.assignee;if(!a)return;
      if(!am[a.accountId])am[a.accountId]={accountId:a.accountId,name:a.displayName,issues:[]};
      am[a.accountId].issues.push({key:i.key,summary:i.fields?.summary,status:i.fields?.status?.name||'To Do',points:i.fields?.customfield_10016||0});
    });

    S.team=Object.values(am).map(mb=>{
      const info=getMI(mb.accountId);
      const cp=mb.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
      const xp=cp*100,level=Math.max(1,Math.floor(xp/500)+1);
      const active=mb.issues.find(i=>i.status==='In Progress')||mb.issues.find(i=>i.status==='In Review');
      const ps=active?active.status:mb.issues.every(i=>i.status==='Done')?'Done':'To Do';
      return{...mb,...info,level,xp:xp%500,prevLevel:level,issueCount:mb.issues.length,completedPts:cp,status:ps,zone:getZone(ps)};
    });

    S.lastSync=new Date();
    log(`âœ… ${S.team.length} heroes ready!`);
    render();
  }catch(e){
    log('âŒ '+e.message);
    document.getElementById('app').innerHTML=`<div class="loading"><div style="font-size:40px">ğŸ’€</div><div style="color:#e43b44;font-size:15px">CONNECTION FAILED</div><div style="color:#566c86;font-size:10px;margin:8px;max-width:400px">${e.message}</div><button onclick="location.reload()" style="margin-top:12px;background:#f0c040;color:#1a1c2c;border:none;padding:8px 24px;border-radius:6px;font-weight:bold">âš¡ Retry</button></div>`;
  }
}

// â”€â”€ CELEBRATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fireConfetti(){
  const colors=['#f0c040','#38b764','#e43b44','#9b59b6','#29adff','#f0a030'];
  for(let i=0;i<80;i++){
    setTimeout(()=>{
      const el=document.createElement('div');
      el.className='confetti-piece';
      el.style.cssText=`left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};animation-duration:${1.5+Math.random()*2}s;animation-delay:0s;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'2px'}`;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),4000);
    },i*25);
  }
}

function shakeScreen(){
  document.body.classList.add('shake');
  setTimeout(()=>document.body.classList.remove('shake'),500);
}

function playSound(type){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    if(type==='done'){
      // Victory fanfare
      [[523,0],[659,0.15],[784,0.3],[1047,0.45]].forEach(([freq,delay])=>{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.connect(g);g.connect(ctx.destination);
        o.frequency.value=freq;o.type='square';
        g.gain.setValueAtTime(0.15,ctx.currentTime+delay);
        g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+delay+0.3);
        o.start(ctx.currentTime+delay);o.stop(ctx.currentTime+delay+0.3);
      });
    } else if(type==='move'){
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);
      o.frequency.value=440;o.type='sine';
      g.gain.setValueAtTime(0.1,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.15);
      o.start();o.stop(ctx.currentTime+0.15);
    }
  }catch(e){}
}

function showLevelUp(hero){
  const el=document.createElement('div');
  el.className='levelup';
  el.innerHTML=`<div class="levelup-box"><div style="font-size:48px">${hero.avatar}</div><div style="color:#f0c040;font-size:22px;font-weight:bold;margin:8px 0">LEVEL UP!</div><div style="color:${hero.color};font-size:16px">${hero.name}</div><div style="color:#566c86;font-size:12px;margin-top:4px">${hero.role} is now Level ${hero.level}!</div></div>`;
  document.getElementById('overlays').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

function showToast(msg,color='#38b764'){
  const existing=document.querySelector('.toast');
  if(existing)existing.remove();
  const el=document.createElement('div');
  el.className='toast';
  el.style.borderColor=color;
  el.innerHTML=msg;
  document.body.appendChild(el);
  clearTimeout(toastTimeout);
  toastTimeout=setTimeout(()=>el?.remove(),3000);
}

// â”€â”€ MOVE TICKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function moveTicket(issueKey, newStatus){
  const issue=S.issues.find(i=>i.key===issueKey);
  if(!issue||issue.status===newStatus)return;

  const oldStatus=issue.status;
  const isDone=newStatus==='Done';

  showToast(`â³ Moving ${issueKey} to ${newStatus}...`,'#f0a030');

  try{
    await updateIssueStatus(issueKey, newStatus);
    issue.status=newStatus;

    // Update team member's issue too
    S.team.forEach(m=>{
      const mi=m.issues?.find(i=>i.key===issueKey);
      if(mi){
        const oldLevel=m.level;
        mi.status=newStatus;
        const cp=m.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
        const xp=cp*100;
        m.completedPts=cp;
        m.xp=xp%500;
        m.level=Math.max(1,Math.floor(xp/500)+1);
        const active=m.issues.find(i=>i.status==='In Progress')||m.issues.find(i=>i.status==='In Review');
        m.status=active?active.status:m.issues.every(i=>i.status==='Done')?'Done':'To Do';
        m.zone=getZone(m.status);

        if(isDone&&m.level>oldLevel){
          setTimeout(()=>showLevelUp(m),600);
        }
      }
    });

    playSound(isDone?'done':'move');
    if(isDone){
      shakeScreen();
      fireConfetti();
      showToast(`ğŸ‰ ${issueKey} COMPLETED! +${issue.points*100||100} XP`,'#38b764');
    } else {
      showToast(`âœ… ${issueKey} â†’ ${newStatus}`,'#38b764');
    }
    render();
  }catch(e){
    issue.status=oldStatus;
    showToast(`âŒ Failed: ${e.message}`,'#e43b44');
    render();
  }
}

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e,key){
  S.dragIssue=key;
  e.dataTransfer.effectAllowed='move';
  setTimeout(()=>{const el=document.querySelector(`[data-key="${key}"]`);if(el)el.classList.add('dragging');},0);
}
function onDragEnd(e){
  document.querySelectorAll('.ticket').forEach(el=>el.classList.remove('dragging'));
  document.querySelectorAll('.col').forEach(el=>el.classList.remove('drag-over'));
}
function onDragOver(e,status){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function onDragLeave(e){e.currentTarget.classList.remove('drag-over');}
function onDrop(e,status){
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if(S.dragIssue)moveTicket(S.dragIssue,status);
  S.dragIssue=null;
}

// â”€â”€ HERO MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openHero(accountId){
  const m=S.team.find(t=>t.accountId===accountId);if(!m)return;
  const heroIssues=S.issues.filter(i=>i.assigneeId===accountId);

  const el=document.createElement('div');
  el.className='modal-bg';
  el.id='heroModal';
  el.onclick=e=>{if(e.target===el)closeModal();};
  el.innerHTML=`
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">âœ•</button>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div style="font-size:48px">${m.avatar}</div>
        <div>
          <div style="color:${m.color};font-size:18px;font-weight:bold">${m.name}</div>
          <div style="color:#566c86;font-size:11px">${m.role} Â· Level ${m.level} Â· ${m.zone}</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            ${[['HP',m.hp,100,'#e43b44'],['MP',m.mp,100,'#3b7fd4'],['XP',m.xp,500,'#f0c040']].map(([l,v,mx,c])=>`
              <div style="display:flex;align-items:center;gap:4px;font-size:9px">
                <span style="color:${c}">${l}</span>
                <div style="background:#111;border-radius:2px;height:4px;width:60px;overflow:hidden"><div style="width:${Math.min(100,(v/mx)*100)}%;background:${c};height:100%"></div></div>
              </div>`).join('')}
          </div>
        </div>
      </div>
      <div style="color:#f0c040;font-size:11px;font-weight:bold;margin-bottom:8px">âš”ï¸ ACTIVE QUESTS (${heroIssues.length})</div>
      <div id="heroQuests">
        ${heroIssues.map(i=>`
          <div class="quest-item" style="border-left-color:${sColor(i.status)}">
            <div style="flex:1;min-width:0">
              <div style="color:#566c86;font-size:9px">${i.key} Â· ${i.points||'?'}pt</div>
              <div style="color:#f4f4f4;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${i.summary}</div>
            </div>
            <select class="status-select" onchange="moveTicket('${i.key}',this.value);setTimeout(()=>openHero('${accountId}'),800)" style="border-color:${sColor(i.status)}">
              ${JIRA_STATUSES.map(s=>`<option value="${s}" ${i.status===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </div>`).join('')}
      </div>
    </div>`;
  document.getElementById('overlays').appendChild(el);
}
function closeModal(){document.getElementById('heroModal')?.remove();}

// â”€â”€ SPRINT TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSprintTimer(){
  if(!S.sprintEnd)return{days:0,pct:0};
  const now=new Date(),end=S.sprintEnd;
  const diff=end-now;
  const days=Math.max(0,Math.ceil(diff/86400000));
  const total=14*86400000;
  const pct=Math.min(100,Math.max(0,100-(diff/total)*100));
  return{days,pct,urgent:days<=2};
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statBar(v,mx,c,h=6){
  return `<div class="bar-wrap" style="height:${h}px"><div class="bar-fill" style="width:${Math.min(100,mx>0?(v/mx)*100:0)}%;background:${c}"></div></div>`;
}

function renderBoard(){
  const cols=JIRA_STATUSES.map(status=>{
    const tickets=S.issues.filter(i=>i.status===status);
    return`<div class="col" id="col-${status.replace(/ /g,'-')}"
      ondragover="onDragOver(event,'${status}')"
      ondragleave="onDragLeave(event)"
      ondrop="onDrop(event,'${status}')">
      <div class="col-title" style="color:${sColor(status)}">${status.toUpperCase()} <span style="color:#566c86;font-weight:normal">(${tickets.length})</span></div>
      ${tickets.map(i=>{
        const mb=S.team.find(m=>m.accountId===i.assigneeId);
        return`<div class="ticket" data-key="${i.key}" draggable="true"
          style="border-left-color:${sColor(i.status)}"
          ondragstart="onDragStart(event,'${i.key}')"
          ondragend="onDragEnd(event)">
          <div class="ticket-key">${i.key}</div>
          <div class="ticket-title">${i.summary?.slice(0,60)}${i.summary?.length>60?'...':''}</div>
          <div class="ticket-meta">
            ${mb?`<span class="ticket-assignee" onclick="openHero('${mb.accountId}')" title="${mb.name}" style="cursor:pointer">${mb.avatar}</span>`:'<span style="color:#566c86;font-size:9px">Unassigned</span>'}
            <span class="ticket-pts">${i.points||'?'}pt</span>
            ${status!=='Done'?`<button class="done-btn" onclick="moveTicket('${i.key}','Done')">âœ“ Done</button>`:'<span style="color:#38b764;font-size:9px;margin-left:auto">âœ“ Complete</span>'}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
  return`<div class="board">${cols}</div>`;
}

function renderMap(){
  const zoneCount=ZONES.map(z=>`
    <div style="display:flex;align-items:center;gap:4px;font-size:10px;color:#566c86">
      <div style="width:8px;height:8px;background:${z.border};border-radius:2px"></div>
      ${z.icon} ${z.name} (${S.team.filter(m=>m.zone===z.name).length})
    </div>`).join('');

  const insp=S.selected?`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <div style="font-size:36px;cursor:pointer" onclick="openHero('${S.selected.accountId}')">${S.selected.avatar}</div>
      <div>
        <div style="color:${S.selected.color};font-size:14px;font-weight:bold">${S.selected.name}</div>
        <div style="color:#566c86;font-size:10px">${S.selected.role} Â· Lv.${S.selected.level}</div>
        <span class="badge" style="background:${sColor(S.selected.status)}">${(S.selected.status||'').toUpperCase()}</span>
      </div>
    </div>
    <div style="background:#0f0f1b;border-radius:6px;padding:8px;margin-bottom:8px;font-size:10px">
      <div style="color:#566c86;margin-bottom:4px">ğŸ“‹ QUESTS (${S.selected.issues?.length||0})</div>
      ${(S.selected.issues||[]).slice(0,3).map(i=>`
        <div style="color:#f4f4f4;margin-bottom:4px;border-left:2px solid ${sColor(i.status)};padding-left:6px;display:flex;align-items:center;gap:4px">
          <span style="color:#566c86;flex-shrink:0">${i.key}</span>
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i.summary?.slice(0,20)}</span>
          <span style="color:#f0c040;flex-shrink:0">${i.points||'?'}pt</span>
        </div>`).join('')}
      <button onclick="openHero('${S.selected.accountId}')" style="margin-top:6px;background:#f0c040;color:#1a1c2c;border:none;border-radius:4px;padding:3px 10px;font-size:9px;font-weight:bold;width:100%">âš”ï¸ MANAGE QUESTS</button>
    </div>
    ${[['HP',S.selected.hp,100,'#e43b44'],['MP',S.selected.mp,100,'#3b7fd4'],['XP',S.selected.xp,500,'#f0c040']].map(([l,v,m,c])=>`
      <div style="display:flex;gap:6px;align-items:center;margin-bottom:5px">
        <span style="color:${c};font-size:10px;width:22px">${l}</span>${statBar(v,m,c,8)}
        <span style="color:${c};font-size:10px;width:55px;text-align:right">${v}/${m}</span>
      </div>`).join('')}`
  :`<div style="color:#566c86;font-size:11px;padding:20px;text-align:center">â†‘ Click a hero<br><span style="font-size:9px">or click avatar to manage quests</span></div>`;

  return`<div class="map-wrap">
    <div>
      <canvas id="mapCanvas" width="640" height="360"></canvas>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">${zoneCount}</div>
    </div>
    <div class="inspector"><div style="color:#f0c040;font-size:11px;font-weight:bold;margin-bottom:8px">ğŸ” INSPECTOR</div>${insp}</div>
  </div>`;
}

function renderRoster(){
  return`<div class="roster">${S.team.map(m=>`
    <div class="card" onclick="openHero('${m.accountId}')" style="border-color:#4a4e8c">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="font-size:22px">${m.avatar}</span>
        <div>
          <div style="color:${m.color};font-weight:bold;font-size:13px">${m.name}</div>
          <div style="color:#566c86;font-size:10px">${m.role} Â· Lv.${m.level}</div>
        </div>
        <span class="badge" style="background:${sColor(m.status)};margin-left:auto">${(m.status||'').toUpperCase()}</span>
      </div>
      <div style="font-size:10px;color:#566c86;margin-bottom:6px">${m.issueCount} quests Â· ${m.completedPts}pt done</div>
      ${[['HP',m.hp,100,'#e43b44'],['MP',m.mp,100,'#3b7fd4'],['XP',m.xp,500,'#f0c040']].map(([l,v,mx,c])=>`
        <div style="display:flex;gap:4px;align-items:center;margin-bottom:3px">
          <span style="font-size:9px;color:${c};width:18px">${l}</span>${statBar(v,mx,c,5)}<span style="font-size:9px;color:${c}">${v}</span>
        </div>`).join('')}
      <div style="margin-top:8px;text-align:center;background:#0f0f1b;border-radius:4px;padding:4px;font-size:9px;color:#f0c040">âš”ï¸ Click to manage quests</div>
    </div>`).join('')}</div>`;
}

function renderLeaderboard(){
  const sorted=[...S.team].sort((a,b)=>(b.level*1000+b.xp)-(a.level*1000+a.xp));
  return`<div style="max-width:520px;margin:0 auto" class="panel">
    <div style="color:#f0c040;font-size:13px;font-weight:bold;margin-bottom:10px;text-align:center">ğŸ† HALL OF HEROES</div>
    ${sorted.map((m,i)=>`
      <div onclick="openHero('${m.accountId}')" style="display:flex;align-items:center;gap:8px;background:${i===0?'#2a2200':'#16213e'};border:1px solid ${i===0?'#f0c040':'#4a4e8c'};border-radius:6px;padding:7px 10px;margin-bottom:5px;cursor:pointer;" onmouseover="this.style.borderColor='#f0c040'" onmouseout="this.style.borderColor='${i===0?'#f0c040':'#4a4e8c'}'">
        <span style="font-size:16px;width:22px">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||'#'+(i+1)}</span>
        <span style="font-size:18px">${m.avatar}</span>
        <div style="flex:1">
          <div style="color:${m.color};font-size:12px;font-weight:bold">${m.name} <span style="color:#566c86;font-weight:normal">Â· ${m.role}</span></div>
          ${statBar(m.xp,500,'#f0c040',4)}
        </div>
        <div style="text-align:right">
          <div style="color:#f0c040;font-size:13px;font-weight:bold">Lv.${m.level}</div>
          <div style="color:#566c86;font-size:9px">${m.completedPts}pt Â· ${m.issueCount} tasks</div>
        </div>
      </div>`).join('')}
  </div>`;
}

function renderSprintBar(){
  const total=S.issues.reduce((s,i)=>s+(i.points||0),0);
  const done=S.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
  const inprog=S.issues.filter(i=>i.status==='In Progress').reduce((s,i)=>s+(i.points||0),0);
  const rev=S.issues.filter(i=>['In Review','Code Review'].includes(i.status)).reduce((s,i)=>s+(i.points||0),0);
  const pct=total>0?Math.round((done/total)*100):0;
  const timer=getSprintTimer();
  const segs=[{l:'Done',v:done,c:'#38b764'},{l:'Review',v:rev,c:'#9b59b6'},{l:'In Progress',v:inprog,c:'#f0a030'},{l:'To Do',v:total-done-rev-inprog,c:'#566c86'}];
  return`<div class="panel" style="margin-bottom:10px">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="timer-ring" style="border-color:${timer.urgent?'#e43b44':'#f0c040'};color:${timer.urgent?'#e43b44':'#f0c040'}">
        <div style="font-size:14px;font-weight:bold">${timer.days}</div>
        <div style="font-size:8px">days</div>
      </div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <span style="color:#f0c040;font-size:11px;font-weight:bold">âš”ï¸ ${S.sprintName}</span>
          <span style="color:#f0c040;font-size:11px">${done}/${total} pts Â· ${pct}%</span>
        </div>
        <div style="height:16px;display:flex;border-radius:6px;overflow:hidden;border:1px solid #4a4e8c;margin-bottom:6px">
          ${segs.filter(s=>s.v>0).map(s=>`<div style="width:${total>0?(s.v/total)*100:0}%;background:${s.c};transition:width 0.5s" title="${s.l}: ${s.v}pts"></div>`).join('')}
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          ${segs.map(s=>`<div style="display:flex;align-items:center;gap:3px"><div style="width:8px;height:8px;background:${s.c};border-radius:2px"></div><span style="color:#566c86;font-size:9px">${s.l}: ${s.v}pt</span></div>`).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

function render(){
  const tabs=[['board','ğŸ® Quest Board'],['map','ğŸ—ºï¸ Map'],['roster','ğŸ‘¥ Party'],['lead','ğŸ† Ranks']];
  const now=new Date();
  document.getElementById('app').innerHTML=`
    <div class="header">
      <div>
        <div style="color:#f0c040;font-size:18px;font-weight:bold;letter-spacing:2px">âš”ï¸ JIRA QUEST</div>
        <div style="color:#566c86;font-size:10px">BUM Â· ${S.sprintName} Â· ${S.team.length} Heroes Â· Drag tickets to move!</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        ${S.lastSync?`<div style="text-align:center"><div style="color:#38b764;font-size:9px">ğŸŸ¢ LIVE</div><div style="color:#566c86;font-size:8px">${S.lastSync.toLocaleTimeString()}</div></div>`:''}
        <button onclick="fetchData()" style="background:#16213e;color:#29adff;border:1px solid #29adff;border-radius:6px;padding:4px 10px;font-size:10px">âŸ³ Sync</button>
        <div style="text-align:right">
          <div style="color:#29adff;font-size:13px" id="clock">${now.toLocaleTimeString()}</div>
          <div style="color:#566c86;font-size:9px">${now.toLocaleDateString()}</div>
        </div>
      </div>
    </div>
    ${renderSprintBar()}
    <div class="tabs">${tabs.map(([k,l])=>`<button class="tab ${S.tab===k?'active':''}" onclick="setTab('${k}')">${l}</button>`).join('')}</div>
    <div id="content">
      ${S.tab==='board'?renderBoard():S.tab==='map'?renderMap():S.tab==='roster'?renderRoster():renderLeaderboard()}
    </div>
    <div style="margin-top:10px;text-align:center;color:#566c86;font-size:9px">
      âš¡ JIRA QUEST Â· Drag & drop to move tickets Â· Click heroes to manage Â· Auto-syncs every 60s
    </div>`;

  if(S.tab==='map')drawMap();
  setInterval(()=>{const c=document.getElementById('clock');if(c)c.textContent=new Date().toLocaleTimeString();},1000);
}

function setTab(t){S.tab=t;S.selected=null;render();}

// â”€â”€ CANVAS MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMap(){
  const canvas=document.getElementById('mapCanvas');if(!canvas)return;
  canvas.onclick=e=>{
    const r=canvas.getBoundingClientRect(),sx=canvas.width/r.width,sy=canvas.height/r.height;
    const mx=(e.clientX-r.left)*sx,my=(e.clientY-r.top)*sy,W=canvas.width,H=canvas.height;
    let hit=null;
    ZONES.forEach((z,zi)=>{
      const l=ZL[zi],zx=l.x/100*W,zy=l.y/100*H;
      S.team.filter(m=>m.zone===z.name).forEach((m,mi)=>{
        const col=mi%3,row=Math.floor(mi/3);
        if(Math.hypot(mx-(zx+20+col*44),my-(zy+32+row*34))<18)hit=m;
      });
    });
    S.selected=hit;render();
  };
  if(animFrame)clearTimeout(animFrame);
  let tick=0;
  function frame(){
    if(!document.getElementById('mapCanvas'))return;
    tick++;
    const ctx=canvas.getContext('2d'),W=canvas.width,H=canvas.height;
    ctx.fillStyle='#0d1117';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#1a2030';ctx.lineWidth=1;
    for(let x=0;x<W;x+=20){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=0;y<H;y+=20){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    ZONES.forEach((z,zi)=>{
      const l=ZL[zi],zx=l.x/100*W,zy=l.y/100*H,zw=l.w/100*W,zh=l.h/100*H;
      ctx.fillStyle=z.color;ctx.strokeStyle=z.border;ctx.lineWidth=2;
      ctx.beginPath();ctx.roundRect(zx,zy,zw,zh,8);ctx.fill();ctx.stroke();
      ctx.fillStyle=z.border;ctx.font='bold 10px monospace';
      ctx.fillText(`${z.icon} ${z.name}`,zx+6,zy+16);
      S.team.filter(m=>m.zone===z.name).forEach((m,mi)=>{
        const col=mi%3,row=Math.floor(mi/3);
        const wobble=tick%2===0?1.2:-1.2;
        const mx=zx+20+col*44+wobble,my=zy+32+row*34;
        const isSel=S.selected?.accountId===m.accountId;
        if(isSel){ctx.shadowColor=m.color;ctx.shadowBlur=14;}
        ctx.fillStyle=isSel?m.color:m.color+'bb';
        ctx.beginPath();ctx.arc(mx,my,isSel?13:10,0,Math.PI*2);ctx.fill();
        ctx.shadowBlur=0;
        ctx.font=`${isSel?15:12}px serif`;ctx.textAlign='center';
        ctx.fillText(m.avatar,mx,my+5);
        ctx.fillStyle=isSel?'#fff':'#ccc';ctx.font=`bold ${isSel?9:8}px monospace`;
        ctx.fillText(m.name.split(' ')[0],mx,my+24);
        ctx.fillStyle=sColor(m.status);
        ctx.beginPath();ctx.arc(mx+9,my-9,4,0,Math.PI*2);ctx.fill();
      });
    });
    animFrame=setTimeout(frame,700);
  }
  frame();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetchData();
setInterval(fetchData,60000);
</script>

<!-- Update proxy to support POST for Jira transitions -->
<script>
// Patch: the Netlify function needs to support POST for transitions
// Make sure netlify/functions/jira.js handles method param
</script>
</body>
</html>
