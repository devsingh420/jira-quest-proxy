<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>âš”ï¸ Jira Quest</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#1a1c2c;color:#f4f4f4;font-family:monospace;min-height:100vh;padding:10px 12px;overflow-x:hidden;}
button{cursor:pointer;font-family:monospace;}
input,textarea,select{font-family:monospace;}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:8px 14px;background:#16213e;border-radius:8px;border:2px solid #f0c040;box-shadow:0 0 20px #f0c04033;}
.tabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;}
.tab{background:#16213e;color:#566c86;border:1px solid #4a4e8c;border-radius:6px;padding:5px 10px;font-size:11px;font-weight:bold;transition:all 0.2s;}
.tab.active{background:#f0c040;color:#1a1c2c;border-color:#f0c040;}
.panel{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:14px;}
.badge{color:#fff;padding:2px 7px;border-radius:8px;font-size:9px;font-weight:bold;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:#111;}
::-webkit-scrollbar-thumb{background:#4a4e8c;border-radius:2px;}

/* BOARD */
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;align-items:start;}
.col{background:#0f0f1b;border-radius:8px;padding:10px;min-height:300px;border:2px solid transparent;transition:all 0.2s;}
.col.drag-over{border-color:#f0c040;background:#1a1800;box-shadow:0 0 15px #f0c04044;}
.col-title{font-size:11px;font-weight:bold;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #2a2a3a;display:flex;align-items:center;justify-content:space-between;}
.ticket{background:#16213e;border-radius:6px;padding:8px;margin-bottom:6px;cursor:pointer;border-left:3px solid #566c86;font-size:10px;transition:all 0.2s;user-select:none;position:relative;}
.ticket:hover{transform:translateY(-2px);box-shadow:0 4px 16px #00000088;border-left-width:4px;}
.ticket.dragging{opacity:0.3;cursor:grabbing;}
.ticket-key{color:#566c86;font-size:9px;margin-bottom:2px;}
.ticket-title{color:#f4f4f4;line-height:1.4;margin-bottom:6px;}
.ticket-meta{display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
.ticket-pts{background:#2a2a3a;color:#f0c040;padding:1px 5px;border-radius:4px;font-size:9px;}
.grab-handle{position:absolute;top:6px;right:6px;color:#566c86;font-size:10px;cursor:grab;}

/* TICKET MODAL */
.modal-bg{position:fixed;inset:0;background:#000000dd;z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.modal{background:#16213e;border:2px solid #4a4e8c;border-radius:12px;padding:0;width:680px;max-width:96vw;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;position:relative;}
.modal-header{padding:16px 20px 12px;border-bottom:1px solid #2a2a3a;background:#0f0f1b;}
.modal-body{padding:16px 20px;overflow-y:auto;flex:1;}
.modal-close{position:absolute;top:12px;right:14px;background:none;border:none;color:#566c86;font-size:18px;cursor:pointer;z-index:1;}
.modal-close:hover{color:#f4f4f4;}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.field{background:#0f0f1b;border-radius:6px;padding:8px;}
.field-label{color:#566c86;font-size:9px;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.field-val{color:#f4f4f4;font-size:11px;}
.desc-box{background:#0f0f1b;border-radius:6px;padding:10px;margin-bottom:12px;font-size:10px;color:#ccc;line-height:1.6;min-height:60px;}
.comment{background:#0f0f1b;border-radius:6px;padding:8px;margin-bottom:6px;font-size:10px;}
.comment-author{color:#f0c040;font-weight:bold;margin-bottom:2px;}
.comment-body{color:#ccc;line-height:1.5;}
.comment-date{color:#566c86;font-size:9px;margin-top:2px;}
.history-item{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid #1a1a2a;font-size:10px;}
.add-comment{width:100%;background:#0f0f1b;border:1px solid #4a4e8c;border-radius:6px;color:#f4f4f4;padding:8px;font-size:10px;resize:vertical;min-height:60px;}
.add-comment:focus{outline:none;border-color:#f0c040;}
.action-btn{background:#16213e;border:1px solid #4a4e8c;color:#f4f4f4;border-radius:6px;padding:5px 12px;font-size:10px;transition:all 0.2s;}
.action-btn:hover{border-color:#f0c040;color:#f0c040;}
.action-btn.primary{background:#f0c040;color:#1a1c2c;border-color:#f0c040;}
.action-btn.primary:hover{background:#ffd700;}
.action-btn.danger{border-color:#e43b44;color:#e43b44;}
.section-title{color:#f0c040;font-size:11px;font-weight:bold;margin:14px 0 8px;display:flex;align-items:center;gap:6px;}

/* SPRINT BAR */
.sprint-bar{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;}
.timer-ring{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;border:3px solid #f0c040;flex-shrink:0;}

/* BURNDOWN */
.chart-wrap{background:#0f0f1b;border-radius:8px;padding:10px;margin-top:10px;}

/* MAP */
.map-container{position:relative;width:100%;border-radius:8px;overflow:hidden;border:2px solid #4a4e8c;}
#mapCanvas{display:block;width:100%;image-rendering:pixelated;}
.map-wrap{display:grid;grid-template-columns:1fr 240px;gap:10px;}
.inspector{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:12px;max-height:500px;overflow-y:auto;}

/* ROSTER */
.roster{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;}
.hero-card{background:#16213e;border:2px solid #4a4e8c;border-radius:8px;padding:10px;cursor:pointer;transition:all 0.2s;}
.hero-card:hover{border-color:#f0c040;transform:translateY(-2px);box-shadow:0 4px 16px #00000066;}

/* ACTIVITY FEED */
.feed{position:fixed;bottom:12px;left:12px;width:260px;max-height:140px;overflow:hidden;z-index:50;pointer-events:none;}
.feed-item{background:#16213e;border:1px solid #4a4e8c;border-radius:6px;padding:5px 8px;font-size:9px;color:#ccc;margin-bottom:3px;animation:feedIn 0.3s ease-out;}
@keyframes feedIn{from{transform:translateX(-20px);opacity:0;}to{transform:translateX(0);opacity:1;}}

/* LEADERBOARD */
.lb-row{display:flex;align-items:center;gap:8px;background:#16213e;border:1px solid #4a4e8c;border-radius:6px;padding:7px 10px;margin-bottom:5px;cursor:pointer;transition:all 0.2s;}
.lb-row:hover{border-color:#f0c040;}

/* CELEBRATIONS */
.confetti-piece{position:fixed;width:8px;height:8px;top:-10px;z-index:999;pointer-events:none;border-radius:2px;animation:cFall linear forwards;}
@keyframes cFall{0%{transform:translateY(0) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}
.levelup-overlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.levelup-box{background:#1a1c2c;border:3px solid #f0c040;border-radius:16px;padding:28px 44px;text-align:center;animation:luPop 0.4s ease-out,luFade 0.5s 2.2s forwards;box-shadow:0 0 60px #f0c04088;}
@keyframes luPop{0%{transform:scale(0.2);opacity:0;}70%{transform:scale(1.1);}100%{transform:scale(1);opacity:1;}}
@keyframes luFade{to{opacity:0;transform:scale(1.1);}}
@keyframes shake{0%,100%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-5px);}80%{transform:translateX(5px);}}
.shake{animation:shake 0.5s ease-out;}
.toast{position:fixed;bottom:20px;right:20px;background:#16213e;border:1px solid #38b764;border-radius:8px;padding:10px 16px;font-size:11px;z-index:300;animation:toastIn 0.3s ease-out,toastOut 0.3s 2.7s forwards;max-width:280px;}
@keyframes toastIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes toastOut{to{transform:translateY(20px);opacity:0;}}
.bar-wrap{background:#111;border-radius:3px;overflow:hidden;flex:1;}
.bar-fill{height:100%;border-radius:3px;transition:width 0.6s;}
.loading{min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;}
</style>
</head>
<body>
<div id="app">
  <div class="loading">
    <div style="font-size:52px">âš”ï¸</div>
    <div style="color:#f0c040;font-size:20px;letter-spacing:4px;margin-bottom:4px">JIRA QUEST</div>
    <div style="color:#566c86;font-size:11px">Summoning heroes...</div>
    <div id="logBox" style="background:#0f0f1b;padding:10px;border-radius:8px;max-height:160px;overflow-y:auto;min-width:300px;margin-top:10px;"></div>
  </div>
</div>
<div id="overlays"></div>
<div id="feed" class="feed"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOARD_ID = 124;
const PROXY = '/.netlify/functions/jira';
const JIRA_STATUSES = ['To Do','In Progress','In Review','Done'];
const SC = {'To Do':'#566c86','In Progress':'#f0a030','In Review':'#9b59b6','Code Review':'#9b59b6','Done':'#38b764','Blocked':'#e43b44','Selected for Development':'#3b7fd4'};
const ROLES=['Warrior','Mage','Ranger','Healer','Rogue','Paladin','Bard','Druid'];
const AVATARS=['âš”ï¸','ğŸ§™','ğŸ¹','âœ¨','ğŸ—¡ï¸','ğŸ›¡ï¸','ğŸµ','ğŸŒ¿','ğŸ”¥','ğŸ’','ğŸŒ™','âš¡'];
const MC=['#9b59b6','#e43b44','#38b764','#29adff','#f0c040','#f0a030','#e91e8c','#00bcd4'];

// ASCII pixel art sprites per zone (3 frames each)
const SPRITES = {
  walk: [
    [' o ','\\|/','/ \\'],
    [' o ',' | ','/ \\'],
    [' o ','/| ','/ \\'],
  ],
  idle: [[' o ',' | ','/ \\']],
  victory: [[' o ','\\o/','/ \\']],
  work: [[' o ',' |_','/  ']],
};

const ZONES=[
  {name:'Feature Forest',bg:'#0d2b0d',border:'#38b764',icon:'ğŸŒ²',match:['in progress'],tileChar:'â™£',tileColor:'#1a4a1a'},
  {name:'Review Citadel',bg:'#1a0d2b',border:'#9b59b6',icon:'ğŸ°',match:['review'],tileChar:'#',tileColor:'#2a1a3a'},
  {name:'Bug Dungeon',bg:'#2b0d0d',border:'#e43b44',icon:'ğŸ•·ï¸',match:['blocked'],tileChar:'â–“',tileColor:'#3a1a1a'},
  {name:'Victory Plains',bg:'#2b2b0d',border:'#f0c040',icon:'ğŸ†',match:['done'],tileChar:'â–‘',tileColor:'#2a2a1a'},
  {name:'Idle Town',bg:'#0d0d2b',border:'#566c86',icon:'ğŸ˜ï¸',match:['to do','backlog','open','selected'],tileChar:'Â·',tileColor:'#1a1a2a'},
];
const ZL=[{x:5,y:5,w:42,h:42},{x:54,y:5,w:42,h:42},{x:5,y:54,w:28,h:42},{x:36,y:54,w:28,h:42},{x:67,y:54,w:28,h:42}];

let S={
  team:[],issues:[],sprintName:'',sprintEnd:null,sprintId:null,
  tab:'board',sel:null,lastSync:null,dragIssue:null,
  heroPositions:{}, // accountId -> {x,y,tx,ty,frame,dir}
  particles:[],dayPhase:0,
};
let mcache={}, mapAnim=null, clockInt=null;
const sColor=s=>SC[s]||'#566c86';
const getZone=s=>ZONES.find(z=>z.match.some(m=>(s||'').toLowerCase().includes(m)))?.name||'Idle Town';
const getMI=id=>{
  if(mcache[id])return mcache[id];
  const i=Object.keys(mcache).length;
  mcache[id]={role:ROLES[i%ROLES.length],avatar:AVATARS[i%AVATARS.length],color:MC[i%MC.length],hp:60+((i*17)%40),mp:40+((i*23)%60)};
  return mcache[id];
};

// â”€â”€ LOGGING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg){
  const b=document.getElementById('logBox');
  if(!b)return;
  const d=document.createElement('div');
  d.style.cssText='color:#29adff;font-size:10px;margin-bottom:2px;';
  d.textContent=msg;
  b.appendChild(d);b.scrollTop=b.scrollHeight;
}

// â”€â”€ JIRA API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function jiraGet(path){
  const res=await fetch(`${PROXY}?path=${encodeURIComponent(path)}`);
  if(!res.ok)throw new Error(`${res.status}: ${await res.text()}`);
  return res.json();
}
async function jiraPost(path,body){
  const res=await fetch(`${PROXY}?path=${encodeURIComponent(path)}&method=POST`,{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
  });
  if(res.status===204)return{};
  if(!res.ok)throw new Error(`${res.status}: ${await res.text()}`);
  return res.json();
}
async function jiraPut(path,body){
  const res=await fetch(`${PROXY}?path=${encodeURIComponent(path)}&method=PUT`,{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
  });
  if(res.status===204)return{};
  if(!res.ok)throw new Error(`${res.status}: ${await res.text()}`);
  return res.json();
}

// â”€â”€ DATA FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchData(silent=false){
  try{
    if(!silent)log('ğŸ”„ Fetching sprint...');
    const sd=await jiraGet(`/rest/agile/1.0/board/${BOARD_ID}/sprint?state=active`);
    const sprint=sd.values?.[0];
    if(!sprint){
      // Check for future sprints to start
      const fs=await jiraGet(`/rest/agile/1.0/board/${BOARD_ID}/sprint?state=future`);
      S.futureSprint=fs.values?.[0]||null;
      S.sprintName='No Active Sprint';
      S.issues=[];S.team=[];
      render();return;
    }
    S.sprintName=sprint.name;
    S.sprintEnd=sprint.endDate?new Date(sprint.endDate):null;
    S.sprintId=sprint.id;
    if(!silent)log(`âœ… ${sprint.name}`);

    if(!silent)log('ğŸ”„ Fetching issues...');
    const id=await jiraGet(`/rest/agile/1.0/board/${BOARD_ID}/sprint/${sprint.id}/issue?maxResults=100&fields=summary,assignee,status,customfield_10016,priority,description,reporter,created,updated,comment,labels,issuetype`);
    const raw=id.issues||[];
    if(!silent)log(`âœ… ${raw.length} issues`);

    S.issues=raw.map(i=>({
      key:i.key,
      summary:i.fields?.summary||'',
      status:i.fields?.status?.name||'To Do',
      assigneeId:i.fields?.assignee?.accountId||null,
      assigneeName:i.fields?.assignee?.displayName||'Unassigned',
      assigneeAvatar:i.fields?.assignee?.avatarUrls?.['24x24']||null,
      points:i.fields?.customfield_10016||0,
      priority:i.fields?.priority?.name||'Medium',
      description:i.fields?.description||null,
      reporter:i.fields?.reporter?.displayName||'?',
      created:i.fields?.created||null,
      updated:i.fields?.updated||null,
      comments:i.fields?.comment?.comments||[],
      labels:i.fields?.labels||[],
      issueType:i.fields?.issuetype?.name||'Story',
    }));

    // Build team
    const am={};
    raw.forEach(i=>{
      const a=i.fields?.assignee;if(!a)return;
      if(!am[a.accountId])am[a.accountId]={accountId:a.accountId,name:a.displayName,issues:[]};
      am[a.accountId].issues.push({key:i.key,summary:i.fields?.summary,status:i.fields?.status?.name||'To Do',points:i.fields?.customfield_10016||0});
    });

    const oldTeam={};
    S.team.forEach(m=>oldTeam[m.accountId]=m);
    S.team=Object.values(am).map(mb=>{
      const info=getMI(mb.accountId);
      const cp=mb.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
      const xp=cp*100,level=Math.max(1,Math.floor(xp/500)+1);
      const active=mb.issues.find(i=>i.status==='In Progress')||mb.issues.find(i=>i.status==='In Review');
      const ps=active?active.status:mb.issues.every(i=>i.status==='Done')?'Done':'To Do';
      const zone=getZone(ps);
      const old=oldTeam[mb.accountId];
      if(old&&old.level<level)setTimeout(()=>showLevelUp({...mb,...info,level}),500);
      return{...mb,...info,level,xp:xp%500,issueCount:mb.issues.length,completedPts:cp,status:ps,zone};
    });

    // Init positions for new heroes
    S.team.forEach(m=>{
      if(!S.heroPositions[m.accountId]){
        const zi=ZONES.findIndex(z=>z.name===m.zone);
        const l=ZL[Math.max(0,zi)];
        S.heroPositions[m.accountId]={
          x:(l.x+5+Math.random()*30)/100,
          y:(l.y+10+Math.random()*25)/100,
          tx:(l.x+5+Math.random()*30)/100,
          ty:(l.y+10+Math.random()*25)/100,
          frame:0,frameTimer:0,dir:1,state:'idle',
        };
      }
    });

    S.lastSync=new Date();
    if(!silent)log(`âœ… ${S.team.length} heroes ready!`);
    render();
  }catch(e){
    log('âŒ '+e.message);
    if(!silent)document.getElementById('app').innerHTML=`<div class="loading"><div style="font-size:40px">ğŸ’€</div><div style="color:#e43b44;font-size:15px;margin:8px 0">FAILED</div><div style="color:#566c86;font-size:10px;max-width:400px;line-height:1.6">${e.message}</div><button onclick="location.reload()" style="margin-top:12px;background:#f0c040;color:#1a1c2c;border:none;padding:8px 24px;border-radius:6px;font-weight:bold;font-size:12px">âš¡ Retry</button></div>`;
  }
}

// â”€â”€ MOVE TICKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function moveTicket(key,newStatus){
  const issue=S.issues.find(i=>i.key===key);
  if(!issue||issue.status===newStatus)return;
  const old=issue.status;
  const isDone=newStatus==='Done';
  showToast(`â³ ${key} â†’ ${newStatus}`,'#f0a030');
  try{
    const td=await jiraGet(`/rest/api/3/issue/${key}/transitions`);
    const tr=td.transitions?.find(t=>t.name===newStatus||t.to?.name===newStatus);
    if(!tr)throw new Error(`No transition "${newStatus}"`);
    await jiraPost(`/rest/api/3/issue/${key}/transitions`,{transition:{id:tr.id}});
    issue.status=newStatus;
    S.team.forEach(m=>{
      const mi=m.issues?.find(i=>i.key===key);
      if(mi){
        mi.status=newStatus;
        const cp=m.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
        m.completedPts=cp;m.xp=(cp*100)%500;m.level=Math.max(1,Math.floor(cp*100/500)+1);
        const active=m.issues.find(i=>i.status==='In Progress')||m.issues.find(i=>i.status==='In Review');
        m.status=active?active.status:m.issues.every(i=>i.status==='Done')?'Done':'To Do';
        const newZone=getZone(m.status);
        if(m.zone!==newZone){
          m.zone=newZone;
          // Walk hero to new zone
          const zi=ZONES.findIndex(z=>z.name===newZone);
          const l=ZL[Math.max(0,zi)];
          const pos=S.heroPositions[m.accountId];
          if(pos){pos.tx=(l.x+8+Math.random()*25)/100;pos.ty=(l.y+10+Math.random()*25)/100;pos.state='walk';}
        }
      }
    });
    addFeed(`${isDone?'ğŸ†':'âš¡'} ${key} moved to ${newStatus}`);
    playSound(isDone?'done':'move');
    if(isDone){shakeScreen();fireConfetti();showToast(`ğŸ‰ ${key} DONE! Quest complete!`,'#38b764');}
    else showToast(`âœ… ${key} â†’ ${newStatus}`,'#38b764');
    render();
  }catch(e){
    issue.status=old;
    showToast(`âŒ ${e.message}`,'#e43b44');
  }
}

// â”€â”€ TICKET MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openTicket(key){
  const issue=S.issues.find(i=>i.key===key);
  if(!issue)return;
  const assignee=S.team.find(m=>m.accountId===issue.assigneeId);

  const renderModal=()=>{
    const el=document.getElementById('ticketModal')||document.createElement('div');
    el.id='ticketModal';el.className='modal-bg';
    el.onclick=e=>{if(e.target===el)el.remove();};

    const descHtml=issue.description
      ?`<div class="desc-box">${renderADF(issue.description)}</div>`
      :`<div class="desc-box" style="color:#566c86;font-style:italic">No description provided.</div>`;

    const priorityColors={'Highest':'#e43b44','High':'#f0a030','Medium':'#f0c040','Low':'#38b764','Lowest':'#566c86'};
    const typeIcons={'Bug':'ğŸ›','Story':'ğŸ“–','Task':'âœ…','Epic':'âš¡','Subtask':'â†³'};

    el.innerHTML=`
    <div class="modal">
      <button class="modal-close" onclick="document.getElementById('ticketModal').remove()">âœ•</button>
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:16px">${typeIcons[issue.issueType]||'ğŸ“‹'}</span>
          <span style="color:#566c86;font-size:11px">${issue.key}</span>
          <span class="badge" style="background:${sColor(issue.status)}">${issue.status.toUpperCase()}</span>
          <span style="color:${priorityColors[issue.priority]||'#566c86'};font-size:10px">â–² ${issue.priority}</span>
          ${issue.points?`<span style="background:#2a2a3a;color:#f0c040;padding:2px 6px;border-radius:4px;font-size:10px">${issue.points} pts</span>`:''}
        </div>
        <div style="color:#f4f4f4;font-size:14px;font-weight:bold;line-height:1.4">${issue.summary}</div>
        ${issue.labels.length?`<div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap">${issue.labels.map(l=>`<span style="background:#2a2a3a;color:#29adff;padding:1px 6px;border-radius:10px;font-size:9px">${l}</span>`).join('')}</div>`:''}
      </div>
      <div class="modal-body">
        <div class="field-row">
          <div class="field">
            <div class="field-label">Assignee</div>
            <div class="field-val" style="display:flex;align-items:center;gap:6px">
              ${assignee?`<span style="font-size:16px">${assignee.avatar}</span><span style="color:${assignee.color}">${assignee.name}</span>`:`<span style="color:#566c86">Unassigned</span>`}
            </div>
            <select onchange="reassignTicket('${issue.key}',this.value)" style="margin-top:6px;background:#16213e;color:#f4f4f4;border:1px solid #4a4e8c;border-radius:4px;padding:3px 6px;font-size:9px;width:100%">
              <option value="">Reassign to...</option>
              ${S.team.map(m=>`<option value="${m.accountId}" ${m.accountId===issue.assigneeId?'selected':''}>${m.avatar} ${m.name}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <div class="field-label">Status</div>
            <div style="display:flex;flex-direction:column;gap:4px;margin-top:4px">
              ${JIRA_STATUSES.map(s=>`<button onclick="moveTicket('${issue.key}','${s}');setTimeout(()=>openTicket('${issue.key}'),600)" style="background:${issue.status===s?sColor(s):'#2a2a3a'};color:${issue.status===s?'#fff':'#aaa'};border:none;border-radius:4px;padding:3px 8px;font-size:9px;text-align:left;cursor:pointer">${issue.status===s?'â–¶ ':''} ${s}</button>`).join('')}
            </div>
          </div>
        </div>
        <div class="field-row">
          <div class="field"><div class="field-label">Reporter</div><div class="field-val">${issue.reporter}</div></div>
          <div class="field"><div class="field-label">Created</div><div class="field-val">${issue.created?new Date(issue.created).toLocaleDateString():'-'}</div></div>
        </div>

        <div class="section-title">ğŸ“– Description</div>
        ${descHtml}

        <div class="section-title">ğŸ’¬ Comments (${issue.comments.length})</div>
        <div id="commentsList">
          ${issue.comments.map(c=>`
            <div class="comment">
              <div class="comment-author">${c.author?.displayName||'?'}</div>
              <div class="comment-body">${renderADF(c.body)}</div>
              <div class="comment-date">${new Date(c.created).toLocaleString()}</div>
            </div>`).join('')||'<div style="color:#566c86;font-size:10px;padding:8px 0">No comments yet.</div>'}
        </div>

        <div class="section-title">âœï¸ Add Comment</div>
        <textarea class="add-comment" id="commentInput" placeholder="Write a comment..."></textarea>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="action-btn primary" onclick="addComment('${issue.key}')">ğŸ’¬ Submit</button>
          <button class="action-btn" onclick="document.getElementById('ticketModal').remove()">Cancel</button>
        </div>
      </div>
    </div>`;

    if(!document.getElementById('ticketModal'))document.getElementById('overlays').appendChild(el);
    else document.getElementById('overlays').replaceChild(el,document.getElementById('ticketModal'));
  };
  renderModal();
}

function renderADF(node){
  if(!node)return '';
  if(typeof node==='string')return node;
  if(node.type==='doc')return (node.content||[]).map(renderADF).join('');
  if(node.type==='paragraph')return `<p style="margin-bottom:6px">${(node.content||[]).map(renderADF).join('')}</p>`;
  if(node.type==='text'){
    let t=node.text||'';
    (node.marks||[]).forEach(m=>{
      if(m.type==='strong')t=`<strong>${t}</strong>`;
      if(m.type==='em')t=`<em>${t}</em>`;
      if(m.type==='code')t=`<code style="background:#2a2a3a;padding:1px 4px;border-radius:3px">${t}</code>`;
    });
    return t;
  }
  if(node.type==='bulletList')return `<ul style="padding-left:16px;margin-bottom:6px">${(node.content||[]).map(renderADF).join('')}</ul>`;
  if(node.type==='listItem')return `<li style="margin-bottom:2px">${(node.content||[]).map(renderADF).join('')}</li>`;
  if(node.type==='codeBlock')return `<pre style="background:#2a2a3a;padding:8px;border-radius:4px;overflow-x:auto;font-size:9px;margin-bottom:6px">${(node.content||[]).map(renderADF).join('')}</pre>`;
  if(node.type==='hardBreak')return '<br>';
  if(node.type==='heading')return `<h${node.attrs?.level||3} style="margin-bottom:6px;color:#f0c040">${(node.content||[]).map(renderADF).join('')}</h${node.attrs?.level||3}>`;
  return (node.content||[]).map(renderADF).join('');
}

async function addComment(key){
  const input=document.getElementById('commentInput');
  const text=input?.value?.trim();
  if(!text)return;
  try{
    showToast('ğŸ’¬ Posting comment...','#f0a030');
    await jiraPost(`/rest/api/3/issue/${key}/comment`,{
      body:{type:'doc',version:1,content:[{type:'paragraph',content:[{type:'text',text}]}]}
    });
    const issue=S.issues.find(i=>i.key===key);
    if(issue)issue.comments.push({author:{displayName:'Me'},body:{type:'doc',version:1,content:[{type:'paragraph',content:[{type:'text',text}]}]},created:new Date().toISOString()});
    showToast('âœ… Comment posted!','#38b764');
    addFeed(`ğŸ’¬ Comment on ${key}`);
    openTicket(key);
  }catch(e){showToast('âŒ '+e.message,'#e43b44');}
}

async function reassignTicket(key,accountId){
  if(!accountId)return;
  try{
    await jiraPut(`/rest/api/3/issue/${key}`,{fields:{assignee:{accountId}}});
    const issue=S.issues.find(i=>i.key===key);
    if(issue){
      issue.assigneeId=accountId;
      const m=S.team.find(t=>t.accountId===accountId);
      issue.assigneeName=m?.name||'Unknown';
    }
    showToast('âœ… Reassigned!','#38b764');
    addFeed(`ğŸ‘¤ ${key} reassigned`);
    render();
    openTicket(key);
  }catch(e){showToast('âŒ '+e.message,'#e43b44');}
}

// â”€â”€ SPRINT ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startSprint(){
  if(!S.futureSprint)return;
  try{
    showToast('â³ Starting sprint...','#f0a030');
    const now=new Date(),end=new Date(now.getTime()+14*86400000);
    await jiraPost(`/rest/agile/1.0/sprint/${S.futureSprint.id}`,{state:'active',startDate:now.toISOString(),endDate:end.toISOString()});
    showToast('âš”ï¸ Sprint started! Let the quest begin!','#38b764');
    fireConfetti();
    await fetchData();
  }catch(e){showToast('âŒ '+e.message,'#e43b44');}
}

async function completeSprint(){
  if(!S.sprintId)return;
  showSprintComplete();
}

function showSprintComplete(){
  const total=S.issues.length;
  const done=S.issues.filter(i=>i.status==='Done').length;
  const pts=S.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
  const el=document.createElement('div');
  el.className='modal-bg';el.id='sprintCompleteModal';
  el.innerHTML=`<div class="modal" style="max-width:480px;text-align:center">
    <div class="modal-header" style="text-align:center">
      <div style="font-size:48px">ğŸ†</div>
      <div style="color:#f0c040;font-size:20px;font-weight:bold;letter-spacing:2px">QUEST COMPLETE!</div>
      <div style="color:#566c86;font-size:11px;margin-top:4px">${S.sprintName}</div>
    </div>
    <div class="modal-body" style="text-align:center">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px">
        <div style="background:#0f0f1b;border-radius:8px;padding:12px"><div style="color:#f0c040;font-size:24px;font-weight:bold">${done}/${total}</div><div style="color:#566c86;font-size:10px">Issues Done</div></div>
        <div style="background:#0f0f1b;border-radius:8px;padding:12px"><div style="color:#38b764;font-size:24px;font-weight:bold">${pts}</div><div style="color:#566c86;font-size:10px">Points Delivered</div></div>
        <div style="background:#0f0f1b;border-radius:8px;padding:12px"><div style="color:#9b59b6;font-size:24px;font-weight:bold">${S.team.length}</div><div style="color:#566c86;font-size:10px">Heroes</div></div>
      </div>
      <div style="color:#f0c040;font-size:11px;font-weight:bold;margin-bottom:8px">ğŸ† HERO HIGHLIGHTS</div>
      ${[...S.team].sort((a,b)=>b.completedPts-a.completedPts).slice(0,3).map((m,i)=>`
        <div style="display:flex;align-items:center;gap:8px;background:#0f0f1b;border-radius:6px;padding:8px;margin-bottom:4px">
          <span>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]}</span><span style="font-size:16px">${m.avatar}</span>
          <span style="color:${m.color};font-weight:bold;flex:1;text-align:left">${m.name}</span>
          <span style="color:#f0c040">${m.completedPts}pt</span>
        </div>`).join('')}
      <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
        <button class="action-btn primary" onclick="confirmCompleteSprint()">âœ… Complete Sprint</button>
        <button class="action-btn" onclick="document.getElementById('sprintCompleteModal').remove()">Cancel</button>
      </div>
    </div>
  </div>`;
  document.getElementById('overlays').appendChild(el);
  fireConfetti();
}

async function confirmCompleteSprint(){
  try{
    // Move incomplete issues to backlog first if needed, then complete
    await jiraPost(`/rest/agile/1.0/sprint/${S.sprintId}`,{state:'closed'});
    document.getElementById('sprintCompleteModal')?.remove();
    showToast('ğŸ† Sprint completed!','#38b764');
    await fetchData();
  }catch(e){showToast('âŒ '+e.message,'#e43b44');}
}

// â”€â”€ BURNDOWN CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBurndown(){
  const total=S.issues.reduce((s,i)=>s+(i.points||0),0);
  const done=S.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
  const inprog=S.issues.filter(i=>i.status==='In Progress').reduce((s,i)=>s+(i.points||0),0);
  const rem=total-done;

  // Fake burndown data based on sprint progress
  let days=14,elapsed=0;
  if(S.sprintEnd){
    const start=new Date(S.sprintEnd.getTime()-14*86400000);
    elapsed=Math.min(14,Math.max(0,Math.floor((new Date()-start)/86400000)));
  }

  const W=500,H=160,pad=30;
  const pts=[];
  for(let d=0;d<=days;d++){
    const ideal=total*(1-d/days);
    let actual=d<elapsed?(total-(done*(d/elapsed))):null;
    pts.push({d,ideal,actual});
  }
  pts[elapsed]={...pts[elapsed],actual:rem};

  let svg=`<svg width="100%" viewBox="0 0 ${W} ${H}" style="display:block">
    <rect width="${W}" height="${H}" fill="#0f0f1b" rx="6"/>
    <!-- Grid -->`;
  for(let i=0;i<=4;i++){
    const y=pad+(H-pad*2)*(i/4);
    const v=Math.round(total*(1-i/4));
    svg+=`<line x1="${pad}" y1="${y}" x2="${W-10}" y2="${y}" stroke="#2a2a3a" stroke-width="1"/>
    <text x="${pad-4}" y="${y+4}" fill="#566c86" font-size="8" text-anchor="end" font-family="monospace">${v}</text>`;
  }
  for(let d=0;d<=days;d+=2){
    const x=pad+(W-pad-10)*(d/days);
    svg+=`<text x="${x}" y="${H-6}" fill="#566c86" font-size="8" text-anchor="middle" font-family="monospace">D${d}</text>`;
  }

  // Ideal line
  const iPath=pts.map((p,i)=>{
    const x=pad+(W-pad-10)*(p.d/days);
    const y=pad+(H-pad*2)*(1-p.ideal/total);
    return`${i===0?'M':'L'}${x},${y}`;
  }).join(' ');
  svg+=`<path d="${iPath}" stroke="#566c86" stroke-width="1.5" fill="none" stroke-dasharray="4,3"/>`;

  // Actual line
  const aPts=pts.filter(p=>p.actual!==null);
  if(aPts.length>1){
    const aPath=aPts.map((p,i)=>{
      const x=pad+(W-pad-10)*(p.d/days);
      const y=pad+(H-pad*2)*(1-Math.max(0,p.actual)/total);
      return`${i===0?'M':'L'}${x},${y}`;
    }).join(' ');
    svg+=`<path d="${aPath}" stroke="#f0c040" stroke-width="2" fill="none"/>`;
    const last=aPts[aPts.length-1];
    const lx=pad+(W-pad-10)*(last.d/days);
    const ly=pad+(H-pad*2)*(1-Math.max(0,last.actual)/total);
    svg+=`<circle cx="${lx}" cy="${ly}" r="4" fill="#f0c040"/>`;
  }

  svg+=`<!-- Legend -->
    <text x="${W-10}" y="20" fill="#566c86" font-size="8" text-anchor="end" font-family="monospace">â”€â”€â”€ ideal</text>
    <text x="${W-10}" y="32" fill="#f0c040" font-size="8" text-anchor="end" font-family="monospace">â”€â”€â”€ actual</text>
  </svg>`;
  return`<div style="margin-bottom:8px"><div style="color:#f0c040;font-size:11px;font-weight:bold;margin-bottom:6px">ğŸ“‰ BURNDOWN CHART</div>${svg}</div>`;
}

// â”€â”€ RETRO MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMap(){
  const canvas=document.getElementById('mapCanvas');
  if(!canvas)return;
  const W=640,H=360;
  canvas.width=W;canvas.height=H;

  canvas.onclick=e=>{
    const r=canvas.getBoundingClientRect(),sx=W/r.width,sy=H/r.height;
    const mx=(e.clientX-r.left)*sx,my=(e.clientY-r.top)*sy;
    let hit=null;
    S.team.forEach(m=>{
      const p=S.heroPositions[m.accountId];
      if(p&&Math.hypot(mx-p.x*W,my-p.y*H)<18)hit=m;
    });
    S.sel=hit;
    if(hit)openTicketsByHero(hit);
    else renderMapInspector();
  };

  if(mapAnim)clearTimeout(mapAnim);
  let t=0;

  function frame(){
    if(!document.getElementById('mapCanvas'))return;
    t++;
    const ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,W,H);

    // Sky / bg
    const dayPct=(Math.sin(t/200)+1)/2;
    const r=Math.round(13+dayPct*20),g=Math.round(13+dayPct*15),b=Math.round(44+dayPct*30);
    ctx.fillStyle=`rgb(${r},${g},${b})`;
    ctx.fillRect(0,0,W,H);

    // Stars (night)
    if(dayPct<0.5){
      ctx.fillStyle=`rgba(255,255,255,${(0.5-dayPct)*1.5})`;
      for(let s=0;s<40;s++){
        const sx=(s*137.5)%W, sy=(s*97.3)%H;
        if(Math.sin(t/30+s)>0.8)ctx.fillRect(sx,sy,1,1);
      }
    }

    // Draw pixel grid
    ctx.strokeStyle='rgba(255,255,255,0.03)';ctx.lineWidth=1;
    for(let x=0;x<W;x+=8){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=0;y<H;y+=8){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

    // Draw zones as islands
    ZONES.forEach((z,zi)=>{
      const l=ZL[zi];
      const zx=l.x/100*W, zy=l.y/100*H, zw=l.w/100*W, zh=l.h/100*H;

      // Island shadow
      ctx.fillStyle='rgba(0,0,0,0.3)';
      ctx.beginPath();ctx.ellipse(zx+zw/2+4,zy+zh+4,zw/2,10,0,0,Math.PI*2);ctx.fill();

      // Island base (water rim)
      ctx.fillStyle=z.border+'33';
      ctx.beginPath();ctx.ellipse(zx+zw/2,zy+zh/2,zw/2+6,zh/2+6,0,0,Math.PI*2);ctx.fill();

      // Island land
      ctx.fillStyle=z.bg;
      ctx.strokeStyle=z.border;ctx.lineWidth=2;
      ctx.beginPath();ctx.roundRect(zx,zy,zw,zh,12);ctx.fill();ctx.stroke();

      // Tile texture
      ctx.fillStyle=z.tileColor;
      for(let tx=zx+4;tx<zx+zw-4;tx+=8){
        for(let ty=zy+4;ty<zy+zh-4;ty+=8){
          if((Math.floor(tx/8)+Math.floor(ty/8))%3===0)ctx.fillRect(tx,ty,6,6);
        }
      }

      // Zone decoration
      const dec=zi===0?'ğŸŒ²':zi===1?'ğŸ°':zi===2?'â˜ ï¸':zi===3?'â­':'ğŸ ';
      ctx.font='14px serif';ctx.textAlign='center';
      ctx.fillText(dec,zx+zw/2,zy+14);

      // Zone name
      ctx.fillStyle=z.border;ctx.font='bold 8px monospace';ctx.textAlign='center';
      ctx.fillText(z.name.toUpperCase(),zx+zw/2,zy+zh-4);

      // Member count badge
      const cnt=S.team.filter(m=>m.zone===z.name).length;
      if(cnt>0){
        ctx.fillStyle=z.border;
        ctx.beginPath();ctx.arc(zx+zw-8,zy+8,8,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#fff';ctx.font='bold 8px monospace';ctx.textAlign='center';
        ctx.fillText(cnt,zx+zw-8,zy+11);
      }

      // Ambient particles
      if(t%3===0&&Math.random()>0.7){
        S.particles.push({
          x:zx+Math.random()*zw,y:zy+Math.random()*zh,
          vx:(Math.random()-0.5)*0.5,vy:-Math.random()*0.8,
          life:40,maxLife:40,color:z.border,size:zi===2?2:1.5
        });
      }
    });

    // Draw water paths between islands
    ctx.strokeStyle='rgba(41,173,255,0.2)';ctx.lineWidth=3;ctx.setLineDash([8,6]);
    [[0,1],[0,2],[1,3],[2,4],[3,4]].forEach(([a,b])=>{
      const la=ZL[a],lb=ZL[b];
      ctx.beginPath();
      ctx.moveTo((la.x+la.w/2)/100*W,(la.y+la.h/2)/100*H);
      ctx.lineTo((lb.x+lb.w/2)/100*W,(lb.y+lb.h/2)/100*H);
      ctx.stroke();
    });
    ctx.setLineDash([]);

    // Particles
    S.particles=S.particles.filter(p=>{
      p.x+=p.vx;p.y+=p.vy;p.life--;
      if(p.life<=0)return false;
      ctx.globalAlpha=p.life/p.maxLife*0.8;
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x,p.y,p.size,p.size);
      ctx.globalAlpha=1;
      return true;
    });

    // Draw heroes as ASCII pixel art
    S.team.forEach(m=>{
      const pos=S.heroPositions[m.accountId];
      if(!pos)return;

      // Move toward target
      const dx=pos.tx-pos.x, dy=pos.ty-pos.y;
      const dist=Math.hypot(dx,dy);
      if(dist>0.005){
        pos.x+=dx*0.04;pos.y+=dy*0.04;
        pos.dir=dx>0?1:-1;
        pos.state='walk';
      } else {
        pos.state=m.status==='In Progress'?'work':'idle';
        // Wander occasionally
        if(t%120===0&&Math.random()>0.5){
          const zi=ZONES.findIndex(z=>z.name===m.zone);
          const l=ZL[Math.max(0,zi)];
          pos.tx=(l.x+5+Math.random()*30)/100;
          pos.ty=(l.y+8+Math.random()*28)/100;
        }
      }

      // Animate frame
      pos.frameTimer=(pos.frameTimer||0)+1;
      if(pos.frameTimer%8===0)pos.frame=((pos.frame||0)+1)%3;

      const px=pos.x*W, py=pos.y*H;
      const isSel=S.sel?.accountId===m.accountId;

      // Selection glow
      if(isSel){
        ctx.shadowColor=m.color;ctx.shadowBlur=16;
      }

      // Hero base circle
      ctx.fillStyle=m.color+(isSel?'ff':'99');
      ctx.beginPath();ctx.arc(px,py,isSel?11:9,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;

      // ASCII sprite (3 lines, drawn with tiny text)
      const sprite=pos.state==='walk'?SPRITES.walk[pos.frame%3]:
                   pos.state==='work'?SPRITES.work[0]:
                   m.status==='Done'?SPRITES.victory[0]:SPRITES.idle[0];

      ctx.save();
      if(pos.dir<0){ctx.translate(px,py);ctx.scale(-1,1);ctx.translate(-px,-py);}
      ctx.fillStyle='#fff';
      ctx.font='6px monospace';ctx.textAlign='center';
      sprite.forEach((line,li)=>{
        ctx.fillText(line,px,py-6+li*6);
      });
      ctx.restore();

      // Name tag
      ctx.fillStyle=isSel?'#fff':'#ccc';
      ctx.font=`bold ${isSel?9:7}px monospace`;ctx.textAlign='center';
      ctx.fillText(m.name.split(' ')[0],px,py+20);

      // Status dot
      ctx.fillStyle=sColor(m.status);
      ctx.beginPath();ctx.arc(px+8,py-8,3,0,Math.PI*2);ctx.fill();

      // Bubble if working
      if(m.status==='In Progress'&&t%60<30){
        ctx.fillStyle='#f0a030';ctx.font='8px serif';
        ctx.fillText('âš¡',px+10,py-10);
      }
    });

    mapAnim=setTimeout(frame,60); // ~16fps for retro feel
  }
  frame();
}

function openTicketsByHero(hero){
  const heroIssues=S.issues.filter(i=>i.assigneeId===hero.accountId);
  const el=document.createElement('div');
  el.className='modal-bg';el.id='heroModal';
  el.onclick=e=>{if(e.target===el)el.remove();};
  el.innerHTML=`<div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="document.getElementById('heroModal').remove()">âœ•</button>
    <div class="modal-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:44px">${hero.avatar}</div>
        <div>
          <div style="color:${hero.color};font-size:16px;font-weight:bold">${hero.name}</div>
          <div style="color:#566c86;font-size:10px">${hero.role} Â· Level ${hero.level} Â· ${hero.zone}</div>
          <span class="badge" style="background:${sColor(hero.status)};margin-top:4px;display:inline-block">${hero.status.toUpperCase()}</span>
        </div>
      </div>
    </div>
    <div class="modal-body">
      <div style="color:#f0c040;font-size:11px;font-weight:bold;margin-bottom:8px">âš”ï¸ ACTIVE QUESTS (${heroIssues.length})</div>
      ${heroIssues.map(i=>`
        <div style="background:#0f0f1b;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid ${sColor(i.status)};cursor:pointer" onclick="document.getElementById('heroModal').remove();openTicket('${i.key}')">
          <div style="display:flex;align-items:center;gap:6px">
            <span style="color:#566c86;font-size:9px">${i.key}</span>
            <span class="badge" style="background:${sColor(i.status)}">${i.status.toUpperCase()}</span>
            <span style="background:#2a2a3a;color:#f0c040;padding:1px 5px;border-radius:4px;font-size:9px;margin-left:auto">${i.points||'?'}pt</span>
          </div>
          <div style="color:#f4f4f4;font-size:10px;margin-top:3px">${i.summary}</div>
        </div>`).join('')||'<div style="color:#566c86;font-size:10px">No issues assigned.</div>'}
    </div>
  </div>`;
  document.getElementById('overlays').appendChild(el);
}

function renderMapInspector(){
  const ins=document.getElementById('mapInspector');
  if(!ins)return;
  ins.innerHTML=S.sel?`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer" onclick="openTicketsByHero(S.sel)">
      <div style="font-size:32px">${S.sel.avatar}</div>
      <div>
        <div style="color:${S.sel.color};font-weight:bold">${S.sel.name}</div>
        <div style="color:#566c86;font-size:9px">${S.sel.role} Â· Lv.${S.sel.level}</div>
        <span class="badge" style="background:${sColor(S.sel.status)}">${S.sel.status.toUpperCase()}</span>
      </div>
    </div>
    <button onclick="openTicketsByHero(S.sel)" style="width:100%;background:#f0c040;color:#1a1c2c;border:none;border-radius:4px;padding:4px;font-size:9px;font-weight:bold">âš”ï¸ VIEW QUESTS</button>
    `:`<div style="color:#566c86;font-size:10px;text-align:center;padding:20px">Click a hero<br><span style="font-size:9px">to inspect</span></div>`;
}

// â”€â”€ CELEBRATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fireConfetti(){
  const colors=['#f0c040','#38b764','#e43b44','#9b59b6','#29adff','#f0a030'];
  for(let i=0;i<100;i++){
    setTimeout(()=>{
      const el=document.createElement('div');el.className='confetti-piece';
      el.style.cssText=`left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};animation-duration:${1.5+Math.random()*2}s;width:${5+Math.random()*8}px;height:${5+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'2px'}`;
      document.body.appendChild(el);setTimeout(()=>el.remove(),4000);
    },i*20);
  }
}
function shakeScreen(){document.body.classList.add('shake');setTimeout(()=>document.body.classList.remove('shake'),500);}
function playSound(type){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    if(type==='done'){
      [[523,0],[659,0.12],[784,0.24],[1047,0.38]].forEach(([f,d])=>{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.connect(g);g.connect(ctx.destination);o.frequency.value=f;o.type='square';
        g.gain.setValueAtTime(0.12,ctx.currentTime+d);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+d+0.28);
        o.start(ctx.currentTime+d);o.stop(ctx.currentTime+d+0.28);
      });
    } else {
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);o.frequency.value=440;o.type='sine';
      g.gain.setValueAtTime(0.08,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.12);
      o.start();o.stop(ctx.currentTime+0.12);
    }
  }catch(e){}
}
function showLevelUp(hero){
  const el=document.createElement('div');el.className='levelup-overlay';
  el.innerHTML=`<div class="levelup-box"><div style="font-size:48px">${hero.avatar}</div><div style="color:#f0c040;font-size:22px;font-weight:bold;margin:8px 0;letter-spacing:2px">LEVEL UP!</div><div style="color:${hero.color};font-size:14px">${hero.name} is now Level ${hero.level}!</div></div>`;
  document.getElementById('overlays').appendChild(el);
  setTimeout(()=>el.remove(),3000);
  playSound('done');
}
let toastT=null;
function showToast(msg,color='#38b764'){
  document.querySelector('.toast')?.remove();
  const el=document.createElement('div');el.className='toast';
  el.style.borderColor=color;el.innerHTML=msg;
  document.body.appendChild(el);
  clearTimeout(toastT);toastT=setTimeout(()=>el?.remove(),3200);
}
function addFeed(msg){
  const feed=document.getElementById('feed');if(!feed)return;
  const el=document.createElement('div');el.className='feed-item';el.textContent=msg;
  feed.insertBefore(el,feed.firstChild);
  while(feed.children.length>5)feed.removeChild(feed.lastChild);
  setTimeout(()=>el.remove(),8000);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statBar(v,mx,c,h=6){
  return`<div class="bar-wrap" style="height:${h}px"><div class="bar-fill" style="width:${Math.min(100,mx>0?(v/mx)*100:0)}%;background:${c}"></div></div>`;
}

function renderSprintBar(){
  const total=S.issues.reduce((s,i)=>s+(i.points||0),0);
  const done=S.issues.filter(i=>i.status==='Done').reduce((s,i)=>s+(i.points||0),0);
  const inprog=S.issues.filter(i=>i.status==='In Progress').reduce((s,i)=>s+(i.points||0),0);
  const rev=S.issues.filter(i=>['In Review','Code Review'].includes(i.status)).reduce((s,i)=>s+(i.points||0),0);
  const pct=total>0?Math.round((done/total)*100):0;
  let days=0,urgent=false;
  if(S.sprintEnd){const d=Math.ceil((S.sprintEnd-new Date())/86400000);days=Math.max(0,d);urgent=days<=2;}
  const segs=[{l:'Done',v:done,c:'#38b764'},{l:'Review',v:rev,c:'#9b59b6'},{l:'In Progress',v:inprog,c:'#f0a030'},{l:'To Do',v:total-done-rev-inprog,c:'#566c86'}];
  return`<div class="sprint-bar">
    <div class="timer-ring" style="border-color:${urgent?'#e43b44':'#f0c040'};color:${urgent?'#e43b44':'#f0c040'}">
      <div style="font-size:15px;font-weight:bold">${days}</div>
      <div style="font-size:7px">DAYS</div>
    </div>
    <div style="flex:1">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="color:#f0c040;font-size:11px;font-weight:bold">âš”ï¸ ${S.sprintName}</span>
        <div style="display:flex;gap:6px">
          <span style="color:#f0c040;font-size:11px">${done}/${total}pts Â· ${pct}%</span>
          <button onclick="completeSprint()" style="background:#2a1a1a;color:#e43b44;border:1px solid #e43b44;border-radius:4px;padding:2px 8px;font-size:9px">ğŸ End Sprint</button>
        </div>
      </div>
      <div style="height:14px;display:flex;border-radius:4px;overflow:hidden;margin-bottom:4px">
        ${segs.filter(s=>s.v>0).map(s=>`<div style="width:${total>0?(s.v/total)*100:0}%;background:${s.c};transition:width 0.5s" title="${s.l}: ${s.v}pts"></div>`).join('')}
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${segs.map(s=>`<div style="display:flex;align-items:center;gap:3px"><div style="width:8px;height:8px;background:${s.c};border-radius:2px"></div><span style="color:#566c86;font-size:9px">${s.l}: ${s.v}pt</span></div>`).join('')}
      </div>
    </div>
  </div>`;
}

function renderBoard(){
  const cols=JIRA_STATUSES.map(status=>{
    const tickets=S.issues.filter(i=>i.status===status);
    const priorityIcon={'Highest':'ğŸ”´','High':'ğŸŸ ','Medium':'ğŸŸ¡','Low':'ğŸŸ¢','Lowest':'âšª'};
    return`<div class="col" id="col-${status.replace(/ /g,'-')}"
      ondragover="event.preventDefault();event.currentTarget.classList.add('drag-over')"
      ondragleave="event.currentTarget.classList.remove('drag-over')"
      ondrop="event.preventDefault();event.currentTarget.classList.remove('drag-over');if(S.dragIssue)moveTicket(S.dragIssue,this.id.replace('col-','').replace(/-/g,' '));S.dragIssue=null">
      <div class="col-title" style="color:${sColor(status)}">
        <span>${status.toUpperCase()}</span>
        <span style="background:#2a2a3a;color:#566c86;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:normal">${tickets.length}</span>
      </div>
      ${tickets.map(i=>{
        const mb=S.team.find(m=>m.accountId===i.assigneeId);
        return`<div class="ticket" data-key="${i.key}"
          style="border-left-color:${sColor(i.status)}"
          draggable="true"
          ondragstart="S.dragIssue='${i.key}';setTimeout(()=>{const el=document.querySelector('[data-key=\\'${i.key}\\']');if(el)el.classList.add('dragging');},0)"
          ondragend="document.querySelectorAll('.ticket').forEach(e=>e.classList.remove('dragging'))"
          onclick="openTicket('${i.key}')">
          <div class="grab-handle">â ¿</div>
          <div class="ticket-key">${priorityIcon[i.priority]||'âšª'} ${i.key} Â· ${i.issueType}</div>
          <div class="ticket-title">${i.summary?.slice(0,70)}${(i.summary?.length||0)>70?'...':''}</div>
          <div class="ticket-meta">
            ${mb?`<span title="${mb.name}" style="font-size:13px;cursor:pointer" onclick="event.stopPropagation();openTicketsByHero(S.team.find(m=>m.accountId==='${mb.accountId}'))">${mb.avatar}</span>`:'<span style="color:#566c86;font-size:9px">?</span>'}
            ${i.points?`<span class="ticket-pts">${i.points}pt</span>`:''}
            ${i.labels.slice(0,1).map(l=>`<span style="background:#2a2a3a;color:#29adff;padding:1px 5px;border-radius:8px;font-size:8px">${l}</span>`).join('')}
            <button onclick="event.stopPropagation();moveTicket('${i.key}','Done')" style="background:none;border:1px solid #38b764;color:#38b764;border-radius:3px;padding:1px 5px;font-size:8px;margin-left:auto;display:${status==='Done'?'none':'block'}">âœ“</button>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
  return`<div class="board">${cols}</div>`;
}

function renderMap(){
  return`<div class="map-wrap">
    <div>
      <div class="map-container"><canvas id="mapCanvas"></canvas></div>
      <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
        ${ZONES.map(z=>`<div style="display:flex;align-items:center;gap:3px;font-size:9px;color:#566c86"><div style="width:7px;height:7px;background:${z.border};border-radius:2px"></div>${z.icon} ${z.name} (${S.team.filter(m=>m.zone===z.name).length})</div>`).join('')}
      </div>
    </div>
    <div class="inspector">
      <div style="color:#f0c040;font-size:11px;font-weight:bold;margin-bottom:8px">ğŸ” INSPECTOR</div>
      <div id="mapInspector"><div style="color:#566c86;font-size:10px;text-align:center;padding:20px">Click a hero</div></div>
      <div style="border-top:1px solid #2a2a3a;margin-top:10px;padding-top:10px">
        <div style="color:#f0c040;font-size:10px;font-weight:bold;margin-bottom:6px">ğŸ° ZONE STATUS</div>
        ${ZONES.map(z=>`<div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:9px"><span style="color:${z.border}">${z.icon} ${z.name}</span><span style="color:#f0c040">${S.team.filter(m=>m.zone===z.name).length} heroes</span></div>`).join('')}
      </div>
    </div>
  </div>`;
}

function renderRoster(){
  return`<div class="roster">${S.team.map(m=>`
    <div class="hero-card" onclick="openTicketsByHero(S.team.find(t=>t.accountId==='${m.accountId}'))">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:24px">${m.avatar}</span>
        <div>
          <div style="color:${m.color};font-weight:bold;font-size:13px">${m.name}</div>
          <div style="color:#566c86;font-size:9px">${m.role} Â· Lv.${m.level}</div>
        </div>
        <span class="badge" style="background:${sColor(m.status)};margin-left:auto">${m.status.toUpperCase()}</span>
      </div>
      <div style="font-size:9px;color:#566c86;margin-bottom:8px">ğŸ“ ${m.zone} Â· ${m.issueCount} quests Â· ${m.completedPts}pt done</div>
      ${[['HP',m.hp,100,'#e43b44'],['MP',m.mp,100,'#3b7fd4'],['XP',m.xp,500,'#f0c040']].map(([l,v,mx,c])=>`
        <div style="display:flex;gap:4px;align-items:center;margin-bottom:4px">
          <span style="font-size:9px;color:${c};width:18px">${l}</span>${statBar(v,mx,c,5)}<span style="font-size:9px;color:${c}">${v}</span>
        </div>`).join('')}
    </div>`).join('')}</div>`;
}

function renderLeaderboard(){
  const sorted=[...S.team].sort((a,b)=>(b.level*1000+b.xp)-(a.level*1000+a.xp));
  return`<div>
    <div style="max-width:560px;margin:0 auto">
      <div style="color:#f0c040;font-size:14px;font-weight:bold;margin-bottom:12px;text-align:center;letter-spacing:2px">ğŸ† HALL OF HEROES</div>
      ${sorted.map((m,i)=>`
        <div class="lb-row" onclick="openTicketsByHero(S.team.find(t=>t.accountId==='${m.accountId}'))">
          <span style="font-size:18px;width:24px">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||`#${i+1}`}</span>
          <span style="font-size:20px">${m.avatar}</span>
          <div style="flex:1">
            <div style="color:${m.color};font-size:12px;font-weight:bold">${m.name} <span style="color:#566c86;font-weight:normal">Â· ${m.role}</span></div>
            <div style="display:flex;gap:4px;align-items:center;margin-top:2px">${statBar(m.xp,500,'#f0c040',4)}</div>
          </div>
          <div style="text-align:right">
            <div style="color:#f0c040;font-size:14px;font-weight:bold">Lv.${m.level}</div>
            <div style="color:#566c86;font-size:9px">${m.completedPts}pt Â· ${m.issueCount} tasks</div>
          </div>
        </div>`).join('')}
      ${renderBurndown()}
    </div>
  </div>`;
}

function render(){
  if(clockInt)clearInterval(clockInt);
  const tabs=[['board','ğŸ® Board'],['map','ğŸ—ºï¸ Map'],['roster','ğŸ‘¥ Party'],['lead','ğŸ† Ranks']];
  const now=new Date();

  document.getElementById('app').innerHTML=`
    <div class="header">
      <div>
        <div style="color:#f0c040;font-size:16px;font-weight:bold;letter-spacing:2px">âš”ï¸ JIRA QUEST</div>
        <div style="color:#566c86;font-size:9px">BUM Â· ${S.sprintName} Â· ${S.team.length} heroes Â· drag tickets to move!</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        ${S.lastSync?`<div style="text-align:center"><div style="color:#38b764;font-size:8px">ğŸŸ¢ LIVE</div><div style="color:#566c86;font-size:7px">${S.lastSync.toLocaleTimeString()}</div></div>`:''}
        <button onclick="fetchData(true)" style="background:#16213e;color:#29adff;border:1px solid #29adff;border-radius:5px;padding:3px 8px;font-size:9px">âŸ³</button>
        <div style="text-align:right">
          <div style="color:#29adff;font-size:12px" id="clk">${now.toLocaleTimeString()}</div>
          <div style="color:#566c86;font-size:8px">${now.toLocaleDateString()}</div>
        </div>
      </div>
    </div>
    ${renderSprintBar()}
    <div class="tabs">${tabs.map(([k,l])=>`<button class="tab ${S.tab===k?'active':''}" onclick="setTab('${k}')">${l}</button>`).join('')}</div>
    <div id="content">
      ${S.tab==='board'?renderBoard():S.tab==='map'?renderMap():S.tab==='roster'?renderRoster():renderLeaderboard()}
    </div>
    <div style="margin-top:8px;text-align:center;color:#566c86;font-size:8px">
      âš¡ JIRA QUEST Â· Click tickets to open Â· Drag to move Â· Click heroes on map Â· Auto-syncs 60s
    </div>`;

  clockInt=setInterval(()=>{const c=document.getElementById('clk');if(c)c.textContent=new Date().toLocaleTimeString();},1000);

  if(S.tab==='map'){
    drawMap();
  }
}

function setTab(t){
  if(mapAnim){clearTimeout(mapAnim);mapAnim=null;}
  S.tab=t;S.sel=null;render();
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetchData();
setInterval(()=>fetchData(true),60000);
</script>
</body>
</html>
